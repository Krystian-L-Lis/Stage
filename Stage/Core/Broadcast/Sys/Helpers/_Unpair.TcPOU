<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1">
  <POU Name="_Unpair" Id="{b5d024d8-4329-41b6-bfa0-d5611a5f8f33}" SpecialFunc="None">
    <Declaration><![CDATA[FUNCTION INTERNAL _Unpair : Result
VAR_INPUT
	iSignal		: I_SignalNode;
	iReceiver	: I_ReceiverNode;
END_VAR
VAR
	i			: UDINT;
	_nPos		: UDINT;
	_nEnd		: UDINT;
	_nCount		: UDINT;
END_VAR
]]></Declaration>
    <Implementation>
      <ST><![CDATA[IF iSignal = 0 OR iReceiver = 0 THEN
	_Unpair := Err.Itf0;
	RETURN;
END_IF

IF NOT _ArePaired(iSignal, iReceiver, nPos => _nPos) THEN
	_Unpair := None;
	RETURN;
END_IF

_nCount := iSignal.count;
_nEnd := iSignal.id + _nCount - 1;

// Swap with the last receiver if not already the last
IF _nPos <> _nEnd THEN
	_Broadcast.stEntry[_nPos] := _Broadcast.stEntry[_nEnd];
END_IF

// Clear the last entry
_Broadcast.stEntry[_nEnd].iSignal := 0;
_Broadcast.stEntry[_nEnd].iReceiver := 0;

// Update counts
iSignal.count := _nCount - 1;
_Broadcast.nAssigned := _Broadcast.nAssigned - 1;

// Shrink if needed
IF iSignal.count < iSignal.size / 2 THEN
	iSignal.size := iSignal.count;
END_IF

_Unpair := Ok;
]]></ST>
    </Implementation>
  </POU>
</TcPlcObject>